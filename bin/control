#!/bin/zsh

function setup {
    EXE=play
    root="$( cd "$( dirname "$0" )"/.. && pwd )"
    root=~/develop/mholzen/play
    cd $root
    # trap 'kill $(jobs -p)' EXIT
    trap 'echo done' EXIT
    # trap '$(jobs -p)' EXIT

}

function start {
    echo "Starting '$EXE'"

    bin/$EXE >> run/$EXE.stdout 2> run/$EXE.stderr &
    local pid=$!

    echo $pid > run/$EXE.pid
    echo "Running at $pid"
}

function stop {
    echo "Stopping '$EXE'"
    local pid=$(cat run/$EXE.pid)
    kill -9 $pid
    echo "Killed $pid"
}

function restart {
    stop
    start
}

function status {
    local pid=$(cat run/$EXE.pid)

    echo "Status of $pid"
    ps -p $pid -f
    # TODO: display uptime
}

function log {
    trap 'kill $(jobs -p)' EXIT

    echo "Logging $EXE.stdout $EXE.stderr"
    tail -f run/$EXE.stdout | sed 's/^/stdout: /' &
    pid_stdout=$!
    tail -f run/$EXE.stderr | sed 's/^/stderr: /' &
    pid_stderr=$!
    echo 'before wait'
    wait
    echo 'after wait'
    kill -9 $pid_stdout $pid_stderr
}

function set-universe {
    local var=$2
    local val=$3
    (cat universe.json | jq ".$var = $val" > /tmp/universe.json) && mv /tmp/universe.json universe.json
}

function edit {
    ~/.bash/bin/edit
}

setup

cmd="$1"

if [ -z "$cmd" ]; then
    echo "$0 [ start | stop | restart | status | log | set | get | edit ]"
    exit 1
fi

if [ "$cmd" = 'set' ]; then
    cmd=set-universe
fi

$cmd "$@"